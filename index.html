<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (предыдущие стили остаются) ... -->
</head>
<body>
    <!-- ... (навигация и модальные окна из предыдущего кода) ... -->

    <script>
        // Конфигурация API
        const API_URL = 'https://your-api-domain.com/api';
        const AUTH_TOKEN_KEY = 'cryptoAppAuthToken';

        // Состояние приложения
        const state = {
            currentUser: null,
            settings: {}
        };

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem(AUTH_TOKEN_KEY);
            if (token) {
                try {
                    const userData = await fetchUserData(token);
                    state.currentUser = userData;
                    state.settings = await fetchUserSettings(token);
                    updateUI();
                    loadPage(state.settings.lastPage || 'calculator');
                } catch (error) {
                    console.error("Ошибка загрузки данных:", error);
                    logout();
                }
            }
        });

        // API-запросы с обработкой ошибок
        async function makeRequest(endpoint, method, body = null, token = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Ошибка сервера');
                }

                return await response.json();
            } catch (error) {
                console.error(`Ошибка ${method} ${endpoint}:`, error);
                throw error;
            }
        }

        // Регистрация
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                await makeRequest('/auth/register', 'POST', { email, password });
                await login(); // Автовход после регистрации
            } catch (error) {
                document.getElementById('registerError').textContent = error.message;
            }
        }

        // Вход
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { token } = await makeRequest('/auth/login', 'POST', { email, password });
                localStorage.setItem(AUTH_TOKEN_KEY, token);
                
                const [userData, settings] = await Promise.all([
                    fetchUserData(token),
                    fetchUserSettings(token)
                ]);
                
                state.currentUser = userData;
                state.settings = settings;
                updateUI();
                hideModal('loginModal');
                loadPage(settings.lastPage || 'calculator');
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        }

        // Загрузка данных пользователя
        async function fetchUserData(token) {
            return await makeRequest('/auth/me', 'GET', null, token);
        }

        // Загрузка настроек
        async function fetchUserSettings(token) {
            return await makeRequest('/settings', 'GET', null, token);
        }

        // Сохранение настроек
        async function saveSettings() {
            if (!state.currentUser) return;
            
            try {
                await makeRequest('/settings', 'PUT', state.settings, localStorage.getItem(AUTH_TOKEN_KEY));
            } catch (error) {
                console.error("Ошибка сохранения настроек:", error);
            }
        }

        // Выход
        function logout() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            state.currentUser = null;
            updateUI();
            loadPage('calculator');
        }

        // ... (остальные функции из предыдущего кода) ...
    </script>
</body>
</html>
